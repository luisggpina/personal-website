---
# Copyright 2017 LuÃ­s Pina
#
# This file is licensed under the Creative Commons Attribution-NoDerivatives 4.0
# International License. To view a copy of this license, visit
# http://creativecommons.org/licenses/by-nd/4.0/.
#
layout:     post
title:      Matching Linux Processes Through ptrace
tags:       ptrace, linux, varan
group:      "blog"
published:  true
highlight:	true
raphael:		true
comments: False
---

When I discussed [my recent work on Varan](/projects/varan.html) recently, more than one person asked me
a variant of the following question:

> I've been using `ptrace` to force the exact same execution on two processes by
> ensuring both read the same data from their system calls.  Still, at some point,
> they start behaving differently (they diverge).  Why?

`ptrace` is a feature of the Linux kernel. [Quoting it's manual page](http://man7.org/linux/man-pages/man2/ptrace.2.html):

> The ptrace() system call provides a means by which one process (the "tracer")
> may observe and control the execution of another process (the "tracee"), and
> examine and change the tracee's memory and registers.  It is primarily used to
> implement breakpoint debugging and system call tracing.

When the tracee issues a system call, the tracer gets notified.  The tracer can
then change the parameters of the system call, or emulate it in any way.  For
instance, [`strace` uses ptrace to dump the sequence of system calls that a
process issues.](https://strace.io/)

So, we can launch the same program on two processes and use `ptrace` to match
their system calls:  Let one process issue a system call, wait for the other to
issue the same system call, and copy the results over.  If we do this, the two
processes should issue the exact same sequence of system calls with the same
arguments, right?

**Wrong**

In this post, I explain the main reasons why, according to my experience.  I'm
assuming the program is single-threaded.

### Virtual System Calls

### Undefined Behavior

### `rdstc` Instruction

### Shared Memory

### Extra: glibc `get_pid`
